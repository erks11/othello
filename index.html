<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>おせろ</title>
  </head>
  <body>
    <style>
      #tables {
        display: flex;
      }
      #othello {
        border-collapse: collapse;
        background-color: #008080;
        border: 10px solid black;
        border-top-style: none;
        border-left-style: none;
      }
      #battle-status {
        background-color: lavender;
        width: 200px;
        height: 240px;
      }
      th {
        background-color: black;
        color: blanchedalmond;
        font-size: xx-small;
      }
      #othello td {
        border: solid 1px black;
        width: 24px;
        height: 24px;
      }
      #othello td.active {
        background: lightseagreen;
      }
      #othello div {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin: 1px auto;
      }
      div.stone {
        transition: transform 1s linear 0s, background-color 0s linear 0.5s;
      }
      div.black-stone {
        transform: rotateY(180deg);
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: solid 1px #000000;
        background-color: #000000;
        margin: 1px auto;
      }
      div.white-stone {
        transform: rotateY(360deg);
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: solid 1px #000000;
        background-color: #fff8dc;
        margin: 1px auto;
      }
      div.label-you::before {
        content: "あなたの番です";
      }
      div.label-me::before {
        content: "わたしの番です";
      }
    </style>
    <div id="tables">
      <table id="othello">
        <tr>
          <th></th>
          <th>a</th>
          <th>b</th>
          <th>c</th>
          <th>d</th>
          <th>e</th>
          <th>f</th>
          <th>g</th>
          <th>h</th>
        </tr>
        <tr>
          <th>1</th>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
        </tr>
        <tr>
          <th>2</th>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
        </tr>
        <tr>
          <th>3</th>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
        </tr>
        <tr>
          <th>4</th>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
        </tr>
        <tr>
          <th>5</th>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
        </tr>
        <tr>
          <th>6</th>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
        </tr>
        <tr>
          <th>7</th>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
        </tr>
        <tr>
          <th>8</th>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
          <td><div></div></td>
        </tr>
      </table>

      <table id="battle-status">
        <tr>
          <td>○わたし</td>
        </tr>
        <tr>
          <td><div></div></td>
        </tr>
        <tr>
          <td id="stone"></td>
        </tr>
        <tr>
          <td id="winner"></td>
        </tr>
        <tr>
          <td>
            <button id="reset">reset</button>
            <!-- <button>GiveUp</button> -->
          </td>
        </tr>
        <tr>
          <td>●あなた</td>
        </tr>
      </table>
    </div>
    <script>
      const td_list = document.querySelectorAll("#othello td");
      const list = document.querySelectorAll("#othello td div");

      // buttonを押したらresetしたい
      function setOnClickToReset() {
        // button
        let resetButton = document.querySelector("#reset");
        resetButton.addEventListener("click", function() {
          reset();
        });
      }

      function reset() {
        init();
        let winnerStatus = document.querySelector("#winner");
        winnerStatus.innerHTML = "";
      }

      // clickしたときにオセロを置きたい
      function setOnClickToGrid(statusArr, mycolor) {
        for (var i = 0; i < list.length; i++) {
          list[i].addEventListener(
            "click",
            (function(i2) {
              return function(e) {
                // statusArrをクリックした状態に反映したい
                let x = Math.floor(i2 / 8);
                let y = i2 % 8;
                if (statusArr[x][y] > 0) {
                  return;
                }
                if (statusArr[x][y] != -1) {
                  return;
                }
                statusArr[x][y] = mycolor;

                mycolor = changeTurn(mycolor);
                executeOneTurn(statusArr, { x: x, y: y }, mycolor);
              };
            })(i),
            false
          );
        }
      }

      // オセロ１ターンの処理
      function executeOneTurn(statusArr, cood, mycolor) {
        let isFinish = false;
        // ひっくり返す
        reverseStone(statusArr, { x: cood.x, y: cood.y });

        // 次における場所があるかを判断する
        let result = judgeBoard(statusArr, mycolor);
        // 反映する
        reflect(result.statusArr);
        reflectStatus(result.statusArr, mycolor, isFinish);

        // pass判定
        let pass = 0;
        while (!result.isContinue) {
          mycolor = changeTurn(mycolor);
          pass++;
          // passが２回だったらゲーム終了する
          if (pass >= 2) {
            isFinish = true;
            reflectStatus(result.statusArr, mycolor, isFinish);
            break;
          }

          result = judgeBoard(statusArr, mycolor);
          reflect(statusArr);
          reflectStatus(result.statusArr, mycolor, isFinish);
        }
      }

      // statusArrの状態を盤面に反映
      function reflect(statusArr) {
        // 64マス全てに対して、どうなってるのか判断したい
        for (var i = 0; i < statusArr.length; i++) {
          for (var k = 0; k < statusArr[i].length; k++) {
            td_list[8 * i + k].removeAttribute("class");
            if (statusArr[i][k] > 0 && list[8 * i + k].classList.length > 0) {
              list[8 * i + k].setAttribute("class", "stone");
            }
            if (statusArr[i][k] === -1) {
              td_list[8 * i + k].setAttribute("class", "active");
            } else if (statusArr[i][k] === 1) {
              list[8 * i + k].classList.add("white-stone");
            } else if (statusArr[i][k] === 2) {
              list[8 * i + k].classList.add("black-stone");
            } else {
              list[8 * i + k].removeAttribute("class");
            }
          }
        }
        return;
      }

      function reflectStatus(statusArr, mycolor, isFinish) {
        let tdtag = document.querySelector("#battle-status td div");
        if (mycolor === 1) {
          tdtag.setAttribute("class", "label-me");
        } else {
          tdtag.setAttribute("class", "label-you");
        }
        const res = countStone(statusArr);
        let stoneStatus = document.querySelector("#stone");
        stoneStatus.innerHTML = "●:" + res.black + " ○:" + res.white;
        if (isFinish) {
          // 黒と白、石の数を数える
          const res = countStone(statusArr);
          let winnerStatus = document.querySelector("#winner");
          // 勝敗を決める
          if (res.white === res.black) {
            winnerStatus.innerHTML = "引き分け";
          } else if (res.white > res.black) {
            winnerStatus.innerHTML = "わたしの勝ち";
          } else {
            winnerStatus.innerHTML = "あなたの勝ち";
          }
        }
      }

      function changeTurn(mycolor) {
        if (mycolor === 2) {
          mycolor = 1;
        } else {
          mycolor = 2;
        }
        return mycolor;
      }

      // 黒と白の石の数を数える
      function countStone(statusArr) {
        let whiteCount = 0;
        let blackCount = 0;
        for (let i = 0; i < statusArr.length; i++) {
          for (let k = 0; k < statusArr[i].length; k++) {
            if (statusArr[i][k] === 1) {
              whiteCount++;
            } else if (statusArr[i][k] === 2) {
              blackCount++;
            }
          }
        }
        return { white: whiteCount, black: blackCount };
      }

      function reverseStone(statusArr, cood) {
        // 置かれた石の周り８方向をみたい
        let resArr = judgeGridActive(
          statusArr,
          statusArr[cood.x][cood.y],
          cood.x,
          cood.y
        );

        // searchOnewayでarrとxv,yvを受け取り、statusArrを変えてreturnしたい
        resArr.forEach(res => {
          // resArrのresultがtrueのものに対して、処理を行う
          // ここでx,yを定義し、多方向でひっくり返せるようにする
          let x = cood.x;
          let y = cood.y;
          if (res.result) {
            res.arr.forEach(i => {
              if (i != statusArr[x][y]) {
                x += res.xv;
                y += res.yv;
                statusArr[x][y] = statusArr[cood.x][cood.y];
              }
            });
          }
        });
        return statusArr;
      }

      function judgeBoard(statusArr, mycolor) {
        // 白が1　黒が2
        // 64マス全てに対して、置けるかどうか判断したい
        let isContinue = false;
        for (let i = 0; i < statusArr.length; i++) {
          for (let k = 0; k < statusArr[i].length; k++) {
            if (statusArr[i][k] > 0) {
              // すでに置いてあったらスルーする
              continue;
            }
            // いったんactiveを非表示にする
            if (statusArr[i][k] === -1) {
              statusArr[i][k] = 0;
            }

            // 置けるかどうか判断する
            // 置けるならactiveを表示
            let resArr = judgeGridActive(statusArr, mycolor, i, k);
            // resArrのresultに一つでもtrueがあればそのtdをactiveにする
            resArr.forEach(res => {
              if (res.result) {
                isContinue = true;
                statusArr[i][k] = -1;
              }
            });
          }
        }

        return { isContinue: isContinue, statusArr: statusArr };
      }

      // 周囲8マスをみてる
      function judgeGridActive(statusArr, mycolor, i, k) {
        let res;
        let resArr = [];
        for (let i2 = i - 1; i2 <= i + 1; i2++) {
          for (let k2 = k - 1; k2 <= k + 1; k2++) {
            // 自分自身なのでスルー
            if (i2 === i && k2 === k) {
              continue;
            }
            res = searchOneway(
              statusArr,
              { x: i, y: k },
              i2 - i,
              k2 - k,
              mycolor
            );
            resArr.push(res);
          }
        }
        return resArr;
      }

      function searchOneway(statusArr, cood, xv, yv, mycolor) {
        let result = false;
        let arr = [];
        const x = cood.x;
        const y = cood.y;
        let new_cood = { x: x, y: y };
        while (
          new_cood.x < 8 &&
          new_cood.x >= 0 &&
          (new_cood.y < 8 && new_cood.y >= 0)
        ) {
          new_cood.x += xv;
          new_cood.y += yv;
          if (
            new_cood.x >= 0 &&
            new_cood.y >= 0 &&
            new_cood.x < 8 &&
            new_cood.y < 8
          ) {
            let stat = statusArr[new_cood.x][new_cood.y];
            arr.push(stat);
            // 隣が空白か、自分の色だったら抜ける
            if (stat <= 0 || stat == mycolor) {
              break;
            }
          }
        }
        // arr[0]が空白じゃなくて、自分の色でもない
        // arr[1]以上にずっと空白がないかつ自分の色がいる
        if (arr.length >= 2 && arr[arr.length - 1] === mycolor) {
          result = true;
        }
        return { arr: arr, xv: xv, yv: yv, result: result };
      }

      function init() {
        const boardStatus = [
          [0, 0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 1, 2, 0, 0, 0],
          [0, 0, 0, 2, 1, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0, 0]
        ];
        // 黒が自分とする
        let currenTurnColor = 2;
        const result = judgeBoard(boardStatus, currenTurnColor);
        reflect(result.statusArr);
        reflectStatus(result.statusArr, currenTurnColor);

        setOnClickToGrid(result.statusArr, currenTurnColor);
        setOnClickToReset();
      }
      window.onload = init;
    </script>
  </body>
</html>
